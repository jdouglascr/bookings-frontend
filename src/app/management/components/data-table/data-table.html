<div class="data-table-container">
  <!-- Toolbar -->
  <div class="table-toolbar">
    @if (showCreateButton()) {
      <button mat-flat-button color="primary" class="create-btn" (click)="onCreateClick()">
        <mat-icon>add</mat-icon>
        {{ createButtonText() }}
      </button>
    }

    <div class="toolbar-spacer"></div>

    @if (showSearch()) {
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Buscar</mat-label>
        <input matInput [value]="searchTerm()" (input)="onSearchChange($any($event.target).value)" placeholder="Buscar..." />
        <mat-icon matIconPrefix>search</mat-icon>
        @if (searchTerm()) {
          <button mat-icon-button matIconSuffix (click)="clearSearch()" type="button" class="clear-search-btn">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>
    }
  </div>

  <!-- Table Card -->
  <mat-card class="table-card">
    <div class="table-wrapper">
      <table mat-table [dataSource]="isLoading() ? skeletonRows() : paginatedData()" class="data-table">
        <!-- Dynamic Columns -->
        @for (column of columns(); track trackByKey($index, column)) {
          <ng-container [matColumnDef]="column.key">
            <th mat-header-cell *matHeaderCellDef [style.width]="column.width || 'auto'">
              {{ column.label }}
            </th>
            <td mat-cell *matCellDef="let row">
              @if (isLoading()) {
                <div class="skeleton-text"></div>
              } @else {
                @if (column.type === 'avatar') {
                  <div class="avatar-cell">
                    <div class="avatar">
                      {{ column.getAvatarText ? column.getAvatarText(row) : '' }}
                    </div>
                    <span class="avatar-text">{{ column.getValue(row) }}</span>
                  </div>
                } @else {
                  <span class="cell-text">{{ column.getValue(row) }}</span>
                }
              }
            </td>
          </ng-container>
        }

        <!-- Actions Column -->
        @if (actions().length > 0) {
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-header">Acciones</th>
            <td mat-cell *matCellDef="let row" class="actions-cell">
              @if (isLoading()) {
                <div class="skeleton-actions">
                  @for (_ of actions(); track $index) {
                    <div class="skeleton-button"></div>
                  }
                </div>
              } @else {
                <div class="action-buttons">
                  @for (action of actions(); track trackByIcon($index, action)) {
                    <button
                      mat-icon-button
                      [matTooltip]="action.tooltip"
                      (click)="action.handler(row); $event.stopPropagation()"
                      class="action-btn"
                    >
                      <mat-icon>{{ action.icon }}</mat-icon>
                    </button>
                  }
                </div>
              }
            </td>
          </ng-container>
        }

        <!-- Table Rows -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns()"
          (click)="!isLoading() && onRowClick(row)"
          [class.clickable]="!isLoading()"
        ></tr>
      </table>

      <!-- Empty State -->
      @if (!isLoading() && paginatedData().length === 0) {
        <div class="empty-state">
          <mat-icon>{{ emptyIcon() }}</mat-icon>
          <h3>{{ emptyMessage() }}</h3>
          @if (searchTerm()) {
            <p>No se encontraron resultados para "{{ searchTerm() }}"</p>
            <button mat-flat-button color="primary" (click)="clearSearch()">Limpiar b√∫squeda</button>
          }
        </div>
      }
    </div>

    <!-- Paginator -->
    @if (!isLoading() && totalItems() > 0) {
      <mat-paginator
        [length]="totalItems()"
        [pageSize]="pageSize"
        [pageIndex]="currentPage()"
        [hidePageSize]="true"
        (page)="onPageChange($event)"
        showFirstLastButtons
      />
    }
  </mat-card>
</div>
