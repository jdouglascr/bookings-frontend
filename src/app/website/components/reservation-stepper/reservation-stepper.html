<div class="reservation-stepper">
  <button mat-icon-button class="close-button" (click)="closeDialog()" [disabled]="isProcessingBooking()">
    <mat-icon>close</mat-icon>
  </button>

  <header class="stepper-header">
    <div class="steps-container">
      @for (step of steps(); track $index) {
        <div class="step-wrapper">
          <div
            class="step-item"
            [class.completed]="$index < currentStepIndex()"
            [class.active]="$index === currentStepIndex()"
            [class.inactive]="$index > currentStepIndex()"
          >
            <div
              class="step-circle"
              [class.completed]="$index < currentStepIndex()"
              [class.active]="$index === currentStepIndex()"
              [class.inactive]="$index > currentStepIndex()"
            >
              @if ($index < currentStepIndex()) {
                <mat-icon>check</mat-icon>
              } @else {
                <mat-icon>{{ step.icon }}</mat-icon>
              }
            </div>
            <div class="step-label">{{ step.title }}</div>
          </div>
          @if ($index < steps().length - 1) {
            <div class="step-connector" [class.completed]="$index < currentStepIndex()"></div>
          }
        </div>
      }
    </div>
  </header>

  <main class="stepper-content">
    <div
      class="step-container"
      [class.appointment-step]="currentStep().id === 'appointment' || currentStep().id === 'service'"
      [class.datetime-step]="currentStep().id === 'datetime'"
      [class.form-step]="currentStep().id === 'contact'"
    >
      <div class="step-content">
        <h3>{{ currentStep().title }}</h3>
        <p>{{ currentStep().subtitle }}</p>

        @switch (currentStep().id) {
          @case ('service') {
            <app-service-selection
              [selectedService]="stepData().service || null"
              [selectedResourceId]="stepData().resourceId || 0"
              (serviceSelected)="onServiceSelected($event)"
            />
          }
          @case ('appointment') {
            <app-appointment-selection
              [selectedAppointment]="stepData().appointment || null"
              [selectedServiceId]="stepData().serviceId || 0"
              (appointmentSelected)="onAppointmentSelected($event)"
            />
          }
          @case ('datetime') {
            <app-datetime-selection
              [selectedDate]="stepData().selectedDate || null"
              [selectedTimeSlot]="stepData().selectedTimeSlot || null"
              [selectedAppointmentId]="
                mode() === 'admin' ? stepData().resourceServiceId || 0 : stepData().appointment?.resourceServiceId || 0
              "
              (datetimeSelected)="onDatetimeSelected($event)"
              (dateChanged)="onDateChanged($event)"
            />
          }
          @case ('contact') {
            <app-contact-form
              [selectedContactInfo]="stepData().contactInfo || null"
              (contactInfoChanged)="onContactInfoChanged($event)"
              (formValidityChanged)="onContactFormValidityChanged($event)"
            />
          }
          @case ('confirm') {
            <app-reservation-summary [stepData]="stepData()" />
          }
        }
      </div>
    </div>
  </main>

  <footer class="stepper-footer">
    @if (currentStepIndex() > 0) {
      <button mat-stroked-button class="btn-back" (click)="previousStep()" [disabled]="isProcessingBooking()">Atr√°s</button>
    } @else {
      <div></div>
    }

    @if (currentStepIndex() < steps().length - 1) {
      <button
        mat-raised-button
        color="primary"
        class="btn-primary"
        [disabled]="!canProceedToNextStep() || isProcessingBooking()"
        (click)="nextStep()"
      >
        Siguiente
      </button>
    } @else {
      <button mat-raised-button color="primary" class="btn-confirm" [disabled]="isProcessingBooking()" (click)="confirmBooking()">
        @if (isProcessingBooking()) {
          <span class="loading-text">
            <span class="spinner"></span>
            Procesando...
          </span>
        } @else {
          Reservar
        }
      </button>
    }
  </footer>
</div>
